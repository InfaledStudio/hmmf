name: tailscale

# -------------------------------------------------
# 1Ô∏è‚É£  WHEN SHOULD THIS RUN?
# -------------------------------------------------
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:   # manual trigger

# -------------------------------------------------
# 2Ô∏è‚É£  JOB DEFINITION
# -------------------------------------------------
jobs:
  tailscale:
    runs-on: ubuntu-latest
    timeout-minutes: 60            # safety net ‚Äì fails if it hangs

    # -------------------------------------------------
    # 3Ô∏è‚É£  ENVIRONMENT VARIABLES
    # -------------------------------------------------
    env:
      # üëâ  Put your Tailscale auth key (once‚Äëonly) as a repo secret called `TAILSCALE_AUTH_KEY`
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      # Optional: give the node a friendly name (defaults to the GHA hostname)
      TS_NODE_NAME: ${{ runner.name }}

    steps:
      # -------------------------------------------------
      # 4Ô∏è‚É£  CHECKOUT (optional ‚Äì only needed if you run your own code)
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 5Ô∏è‚É£  DOWNLOAD & INSTALL TAILSCALE
      # -------------------------------------------------
      - name: Install Tailscale
        run: |
          # Download the official installer script and pipe it to sudo sh.
          # This pulls the latest stable CLI for the host architecture.
          curl -fsSL https://tailscale.com/install.sh | sudo sh

          # Verify the binary is on PATH
          which tailscale || { echo "‚ùå tailscale binary not found!"; exit 1; }

          # Show version (nice to have for debugging)
          tailscale version

      # -------------------------------------------------
      # 6Ô∏è‚É£  AUTHENTICATE WITH YOUR TAILNET
      # -------------------------------------------------
      - name: Authenticate to Tailscale
        env:
          # The auth key you generated in the Tailscale admin console.
          # You *must* keep it secret ‚Äì add it to the repo Settings ‚Üí Secrets.
          AUTH_KEY: ${{ env.TAILSCALE_AUTH_KEY }}
        run: |
          # If you already have a node cert you can reuse, you can pass it directly:
          sudo tailscale up --authkey "$AUTH_KEY" \
            --hostname "${{ env.TS_NODE_NAME }}" \
            --login-server=https://login.tailscale.com \
            --login-client-id="" \
            --login-client-secret="" \
            --advertise-exit-node \
            --hostname-update=true \
            --sharerouters=false

          # Show that we‚Äôre now a node in the tailnet
          tailscale status

      # -------------------------------------------------
      # 7Ô∏è‚É£  KEEP THE RUNNER ALIVE (so the node stays up)
      # -------------------------------------------------
      # Tailscale runs as a daemon; we just need to keep the process alive
      # until the job finishes (or you explicitly kill it).
      - name: Keep Tailscale daemon alive
        run: |
          # Wait forever (or until the job is cancelled)
          while true; do sleep 60; done &
          TAILPID=$!
          # Forward SIGTERM/SIGINT to the sleep loop so the job can shut down cleanly
          trap "kill $TAILPID" EXIT
          wait $TAILPID
