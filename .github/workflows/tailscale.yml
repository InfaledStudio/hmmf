name: Tailscale ‚Äì automatic node + human‚Äëlogin URL

# -------------------------------------------------------------------
# 1Ô∏è‚É£  WHEN SHOULD THIS RUN?
# -------------------------------------------------------------------
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:   # manual trigger

# -------------------------------------------------------------------
# 2Ô∏è‚É£  JOB DEFINITION
# -------------------------------------------------------------------
jobs:
  tailnet-node:
    runs-on: ubuntu-latest
    timeout-minutes: 60          # safety net ‚Äì fail if it hangs

    # -----------------------------------------------------------------
    # 3Ô∏è‚É£  REPO SECRETS / ENV
    # -----------------------------------------------------------------
    env:
      # üëâ  Create a *single‚Äëuse* Auth Key in the Tailscale admin console
      #     and store it as a secret named `TAILSCALE_AUTH_KEY`.
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}

      # Optional: give the node a friendly name (defaults to the runner name)
      TS_NODE_NAME: ${{ runner.name }}

    steps:
      # -----------------------------------------------------------------
      # 4Ô∏è‚É£  Checkout (only needed if you run your own code later)
      # -----------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------
      # 5Ô∏è‚É£  Install the Tailscale CLI
      # -----------------------------------------------------------------
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          which tailscale || { echo "‚ùå tailscale binary not found!"; exit 1; }
          tailscale version

      # -----------------------------------------------------------------
      # 6Ô∏è‚É£  Bring the runner into your Tailnet
      # -----------------------------------------------------------------
      - name: Authenticate to Tailscale
        env:
          AUTH_KEY: ${{ env.TAILSCALE_AUTH_KEY }}
        run: |
          # This will register the VM as a node in your tailnet.
          # --advertise-exit-node makes it usable as an exit‚Äënode if you need that later.
          sudo tailscale up \
            --authkey "$AUTH_KEY" \
            --hostname "${{ env.TS_NODE_NAME }}" \
            --login-server=https://login.tailscale.com \
            --advertise-exit-node \
            --sharerouters=false

          # Verify we are a node now
          tailscale status

      # -----------------------------------------------------------------
      # 7Ô∏è‚É£  Build a *clickable* login URL and expose it as an output
      # -----------------------------------------------------------------
      - name: Compute login URL
        id: login_url            # <-- this makes the following outputs available
        run: |
          # The URL format is documented by Tailscale:
          #   https://login.tailscale.com/s/<authkey>
          LOGIN_URL="https://login.tailscale.com/s/${{ env.TAILSCALE_AUTH_KEY }}"
          echo "url=$LOGIN_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ  Login URL generated: $LOGIN_URL"

      # -----------------------------------------------------------------
      # 8Ô∏è‚É£  (Optional) Post the URL as a PR comment ‚Äì useful for visual confirmation
      # -----------------------------------------------------------------
      - name: Comment with login URL (only on PRs)
        if: ${{ github.event_name == 'pull_request' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}   # automatically provided token
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### üéüÔ∏è Tailscale node ready
            This runner has been added to your Tailnet.  
            To **manually** join the node (if you ever need to redo the login UI), click the link below:

            [Open login.tailscale.com/s/‚Ä¶](https://login.tailscale.com/s/${{ env.TAILSCALE_AUTH_KEY }})

            *After clicking the link you‚Äôll be taken to the normal Tailscale UI where you can hit ‚ÄúAllow‚Äù.*  

            > **Note:** The link works for **human** interaction only ‚Äì the CI job itself does not open a browser.

      # -----------------------------------------------------------------
      # 9Ô∏è‚É£  Keep the Tailscale daemon alive until the workflow finishes
      # -----------------------------------------------------------------
      - name: Keep daemon alive (so the node stays registered)
        run: |
          # Simple infinite sleep loop ‚Äì dies automatically when the job ends.
          while true; do sleep 60; done &
          PID=$!
          trap "kill $PID" EXIT
          wait $PID
